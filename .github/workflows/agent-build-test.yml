name: Build Agent

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Fix permissions
      run: |
        chmod +x agent/http/compile.sh
        sed -i 's/\r$//' agent/http/compile.sh

    - name: Build using Docker image
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace/agent/http \
          xor1234/agent:latest \
          ./compile.sh

    - name: Verify artifacts
      run: |
        echo "=== Fichiers générés dans agent/http ==="
        ls -la agent/http/*.dll agent/http/*.exe 2>/dev/null || echo "Aucun fichier généré"

        echo "=== Informations ==="
        file agent/http/agent.dll agent/http/agent.exe 2>/dev/null || echo "Fichiers non trouvés"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-agent
        path: |
          agent/http/agent.dll
          agent/http/agent.exe
        if-no-files-found: warn
        retention-days: 30
